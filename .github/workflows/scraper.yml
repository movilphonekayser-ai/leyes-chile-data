name: ğŸ•¸ï¸ Scraper Parlamentario

on:
  schedule:
    # Ejecutar a las 08:00 y 20:00 UTC (05:00 y 17:00 Chile continental)
    - cron: '0 8 * * *'
    - cron: '0 20 * * *'
  
  # EjecuciÃ³n manual desde GitHub UI
  workflow_dispatch:
    inputs:
      force_run:
        description: 'Forzar ejecuciÃ³n completa'
        required: false
        default: 'false'
        type: boolean
  
  # Ejecutar cuando cambien los scripts
  push:
    branches: [ main ]
    paths:
      - 'scrapers/**'
      - '.github/workflows/**'

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: â¬‡ï¸ Checkout del repositorio
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install aiohttp beautifulsoup4 lxml
    
    - name: ğŸ•¸ï¸ Ejecutar scraper
      id: scraper
      run: |
        echo "ğŸ§¹ Limpiando cachÃ©..."
        cd scrapers
        echo "ğŸš€ Iniciando scraping..."
        python scraper.py
        
        # Verificar si se generÃ³ el archivo
        if [ -f "../data/diputados.json" ]; then
          echo "âœ… Scraper completado exitosamente"
          echo "diputados_count=$(jq '.total_diputados' ../data/diputados.json)" >> $GITHUB_OUTPUT
          echo "file_size=$(stat -c%s ../data/diputados.json)" >> $GITHUB_OUTPUT
        else
          echo "âŒ Error: No se generÃ³ diputados.json"
          exit 1
        fi
    
    - name: ğŸ“Š Verificar cambios
      id: check_changes
      run: |
        git status
        if git diff --quiet data/diputados.json; then
          echo "ğŸ“­ No hay cambios en los datos"
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "ğŸ“¬ Hay cambios en los datos"
          echo "has_changes=true" >> $GITHUB_OUTPUT
          
          # Mostrar resumen de cambios
          echo "ğŸ“‹ Resumen de cambios:"
          git diff --stat data/diputados.json
        fi
    
    - name: ğŸ’¾ Commit y push de datos actualizados
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        # Configurar git
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        
        # Agregar y commit
        git add data/diputados.json
        git add data/diputados_min.json 2>/dev/null || true
        
        # Mensaje informativo
        DIPUTADOS_COUNT=$(jq '.total_diputados' data/diputados.json)
        FECHA=$(date +'%Y-%m-%d %H:%M')
        
        git commit -m "ğŸ¤– ActualizaciÃ³n automÃ¡tica ($FECHA)

        ğŸ“Š $DIPUTADOS_COUNT diputados actualizados
        ğŸ”„ Workflow: ${{ github.workflow }}
        ğŸƒ EjecuciÃ³n: ${{ github.run_id }}"
        
        # Push
        git push origin main
    
    - name: ğŸ“¤ Subir artefacto (backup)
      uses: actions/upload-artifact@v4
      with:
        name: datos-parlamentarios-${{ github.run_id }}
        path: data/diputados.json
        retention-days: 7
    
    - name: ğŸ“ Generar reporte
      if: always()
      run: |
        echo "ğŸ“‹ REPORTE DE EJECUCIÃ“N" > report.md
        echo "======================" >> report.md
        echo "" >> report.md
        echo "**Fecha:** $(date)" >> report.md
        echo "**Workflow:** ${{ github.workflow }}" >> report.md
        echo "**Run ID:** ${{ github.run_id }}" >> report.md
        echo "" >> report.md
        
        if [ -f "data/diputados.json" ]; then
          echo "**Estado:** âœ… Ã‰xito" >> report.md
          echo "**Diputados procesados:** $(jq '.total_diputados' data/diputados.json)" >> report.md
          echo "**Ãšltima actualizaciÃ³n:** $(jq -r '.fecha_generacion' data/diputados.json)" >> report.md
        else
          echo "**Estado:** âŒ Fallo" >> report.md
        fi
        
        cat report.md
    
    - name: ğŸš¨ Notificar fallo (opcional)
      if: failure()
      run: |
        echo "âŒ El scraper fallÃ³ en la ejecuciÃ³n ${{ github.run_id }}"
        echo "Revisar logs en: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

# Permisos necesarios
permissions:
  contents: write
